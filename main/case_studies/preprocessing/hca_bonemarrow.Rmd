---
title: Preprocessing HCA Bone Marrow data
author: Davide Risso, Stephanie Hicks, Ruoxi Liu
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, 
                      error = FALSE, message = FALSE, 
                      cache = FALSE)
```


# Data 

We use one of the Human Cell Atlas preview datasets. 
The preview data are available in the 
[`HCAData` Bioconductor package](https://bioconductor.org/packages/release/data/experiment/html/HCAData.html). In this analysis, we will use the 
`ica_bone_marrow` dataset. 

## Data import 
```{r}
library(HCAData)
library(ExperimentHub)
library(SingleCellExperiment)

eh <- ExperimentHub()
query(eh, "HCAData")

##change to ica_bone_marrow
#sce <- HCAData("ica_bone_marrow")

#hub <- ExperimentHub::ExperimentHub()
#rowData <- query(hub, "/Users/April30/Library/Caches/ExperimentHub/ica_bone_marrow_rowData.rds")
#colData <- query(hub, "/Users/April30/Library/Caches/ExperimentHub/ica_bone_marrow_colData.rds")
library(HDF5Array)
rowData <- readRDS("/Users/April30/Library/Caches/ExperimentHub/ica_bone_marrow_rowData.rds")
colData <- readRDS("/Users/April30/Library/Caches/ExperimentHub/ica_bone_marrow_colData.rds")
h5array <- HDF5Array("/Users/April30/Library/Caches/ExperimentHub/ica_bone_marrow_rectangular.h5", "counts")
sce <- SingleCellExperiment(
    list(counts = h5array),
    rowData = rowData,
    colData = colData
  )

rownames(sce) <- rowData(sce)$ID
colnames(sce) <- colData(sce)$Barcode

sce
assay(sce)
```

# Quality control and 

## Removing low-quality cells

First, we use the `scater` package to compute a set of 
QC measures and filter out the low-quality samples.

```{r}
library(scater)
sce <- sce[,sample(1:ncol(sce),size = 1000)]
system.time(sce <- calculateQCMetrics(sce)) 
                          #feature_controls = list(Mito = grep("^MT", rowData(sce)$Symbol))))
                          #BPPARAM = MulticoreParam(1)))
```

We remove cells with high proportion of mitocondrial 
reads, using it as a proxy for cell damage. 

```{r}
high_mito <- isOutlier(sce$pct_counts_Mito, 
                       nmads = 3, type="higher")
table(high_mito)

sce <- sce[,!high_mito]
sce
```

## Removing lowly expressed genes

Next, we remove the lowly expressed genes. Here, 
we keep only those genes that have at least 1 UMI 
in at least 5% of the data. These threshold are
dataset-specific and may need to be taylored to 
specific applications.

```{r}
num_reads <- 1
num_cells <- 0.05*ncol(sce)
system.time(keep <- which(DelayedArray::rowSums(counts(sce) >= num_reads ) >= num_cells))
sce <- sce[keep,]
```

These leaves us with `length(keep)` genes.


**Ruoxi**: save sce object here
