---
title: "default_test"
author: "Yuwei Ni"
date: "3/4/2019"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE}
# package
library(mbkmeans)
library(rhdf5)
library(scater)
library(profvis)
library(mclust)
library(dplyr)
library(cowplot)
library(parallel)
library(rhdf5)


# can see how many cores are available
detectCores() 

# number of cores for parallelization
cores <- 1
B <- 100



## load helper functions
for (f in paste0("/Users/summer/Downloads/package/benchmark-hdf5-clustering/R/",list.files("R", "\\.(r|R)$"))) {
    source(f)
}
```

```{r data}
#data
nC <- 1000  # number of cells
nG <- 500 # number of genes
sim_data <- simulate_gauss_mix(n_cells=nC, n_genes=nG)

data_matrix<-as.matrix(sim_data$obs_data)
data_hdf5<-as(data_matrix,"HDF5Matrix")
```

```{r functions}
#bench_hdf5_accuracy
bench_hdf5_accuracy <- function(i, n_cells, 
                           n_genes, k_centers, 
                           batch_size=batch_size, 
                           num_init = num_init, 
                           max_iters = max_iters, 
                           init_fraction = init_fraction, 
                           initializer = initializer, ...) {
    # simulate data 
    sim_data<-simulate_gauss_mix(n_cells=n_cells, 
                                   n_genes=n_genes)
    data_matrix<-as.matrix(sim_data$obs_data)
    sim_data_hdf5 <- as(data_matrix,"HDF5Matrix")
    
    # apply clustering methods 
    kmeans_output <- stats::kmeans(sim_data$obs_data, 
                                   centers=k_centers)
    mbkmeans_hdf5_output <- mbkmeans::mini_batch(
            sim_data_hdf5, clusters = k_centers, 
            batch_size = batch_size, num_init = num_init, 
            max_iters = max_iters, init_fraction = init_fraction,
            initializer = initializer)

    list(sim_data = sim_data, 
         kmeans_output = kmeans_output, 
         mbkmeans_hdf5_output = mbkmeans_hdf5_output)    
}


#bench_hdf5_time
bench_hdf5_time <- function(i, n_cells, n_genes, k_centers, 
                       batch_size=batch_size, 
                       num_init = num_init, 
                       max_iters = max_iters, 
                       init_fraction = init_fraction, 
                       initializer = initializer, ...) {
    # simulate data 
     sim_data<-simulate_gauss_mix(n_cells=n_cells, 
                                   n_genes=n_genes)
    data_matrix<-as.matrix(sim_data$obs_data)
    sim_data_hdf5 <- as(data_matrix,"HDF5Matrix")
    
    # apply clustering methods 
    kmeans_time <- system.time(stats::kmeans(sim_data$obs_data, 
                                   centers=k_centers))[3]
    
    mbkmeans_hdf5_time <- system.time(mbkmeans::mini_batch(
            sim_data_hdf5, clusters = k_centers, 
            batch_size = batch_size, num_init = num_init, 
            max_iters = max_iters, init_fraction = init_fraction,
            initializer = initializer, ...))[3]

    list(sim_data = sim_data, 
         kmeans_time = kmeans_time, 
         mbkmeans_hdf5_time = mbkmeans_hdf5_time)    
}


#bench_accuracy_calculate_ari
bench_accuracy_calculate_ari <- function(sim_object){
  out <- plyr::ldply(sim_object, function(xx){
    ari_kmeans <- mclust::adjustedRandIndex(
            xx$sim_data$true_cluster_id, 
            as.numeric(xx$kmeans_output$cluster))
    ari_mbkmeans <- mclust::adjustedRandIndex(
            xx$sim_data$true_cluster_id,
            xx$mbkmeans_hdf5_output$Clusters)
  c(ari_kmeans=ari_kmeans, ari_mbkmeans=ari_mbkmeans) 
  })
  return(out)
}

#bench_accuracy_extract_wcss
bench_accuracy_extract_wcss <- function(sim_object){
  out <- plyr::ldply(sim_object, function(xx){
    wcss_kmeans <- sum(xx$kmeans_output$withinss)
    wcss_mbkmeans <- sum(xx$mbkmeans_hdf5_output$WCSS_per_cluster)
    c(wcss_kmeans =wcss_kmeans, wcss_mbkmeans = wcss_mbkmeans )
  })
  return(out)
}

#bench_time_extract
bench_time_extract <- function(sim_object){
  out <- plyr::ldply(sim_object, function(xx){
    time_kmeans <- xx$kmeans_time
    time_mbkmeans <- xx$mbkmeans_hdf5_time
    c(time_kmeans =time_kmeans, time_mbkmeans = time_mbkmeans)
  })
  return(out)
}

```



### `batch_size = 1` (or .1 percent of data)
```{r}
nC <- 1000
nG <- 500
mbkmeans_initializer = "random"


# simulate data to assess accuracy
save_bs_0001 <- mclapply(seq_len(B),
                  n_cells = nC, n_genes = nG, 
                  bench_hdf5_accuracy, k_centers = 3,
                  batch_size = nC*.001, num_init = 10, max_iters = 100, 
                  init_fraction = .1, initializer = mbkmeans_initializer, 
                  mc.cores=cores, calc_wcss = TRUE)



# calculate adjusted Rand Index 
ari_output_bs_0001_ari <- bench_accuracy_calculate_ari(save_bs_0001)

# extract wcss
ari_output_bs_0001_wcss <- bench_accuracy_extract_wcss(save_bs_0001)

# simulate data to asses compute time
# and we set: num_init = 1, calc_wcss = FALSE
save_bs_time_0001 <- mclapply(seq_len(B),
                  n_cells = nC, n_genes = nG, 
                  bench_hdf5_time, k_centers = 3,
                  batch_size = nC*.001, num_init = 1, max_iters = 100, 
                  init_fraction = .1, initializer = mbkmeans_initializer, 
                  mc.cores=cores, calc_wcss = FALSE)

# extract compute time
time_output_bs_0001 <- bench_time_extract(save_bs_time_0001)
```

```{r}
# boxplots
p_bs_0001_ari <- tidyr::gather(ari_output_bs_0001_ari) %>% 
    ggplot(aes(x=key, y = value)) + 
    geom_boxplot() + geom_jitter() + 
    xlab("clustering method") + 
    ylab("adjusted rand index") + 
    ggtitle("batch_size = 1 (0.1% of data)")
p_bs_0001_ari

p_bs_0001_wcss <- tidyr::gather(ari_output_bs_0001_wcss) %>% 
    ggplot(aes(x=key, y = value)) + 
    geom_boxplot() + geom_jitter() + 
    xlab("clustering method") + 
    ylab("within cluster sum of squares") + 
    ggtitle("batch_size = 1 (0.1% of data)")
p_bs_0001_wcss

p_bs_0001_time <- tidyr::gather(time_output_bs_0001) %>% 
    ggplot(aes(x=key, y = value)) + 
    geom_boxplot() + geom_jitter() + 
    xlab("clustering method") + 
    ylab("compute time") + 
    ggtitle("batch_size = 1 (0.1% of data)")
p_bs_0001_time
```

```












```{r calculation,warning=FALSE}
#kmeans
km1<-kmeans(data_matrix,centers = 3,iter.max = 10,nstart=1)

#tradition
km_matrix<-mbkmeans::mini_batch(data_matrix,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "random")

km_hdf5<-mbkmeans::mini_batch(data_hdf5,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "random")

#kmeans++
kmplus_matrix<-mbkmeans::mini_batch(data_matrix,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "kmeans++")

kmplus_hdf5<-mbkmeans::mini_batch(data_hdf5,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "kmeans++")

```

```{r time,warning=FALSE}
#system_time

#km
km_time<-numeric(50)
for(i in 1:50){
km_time[i] = system.time(kmeans(data_matrix,centers = 3,iter.max = 10,nstart=1))[3]
}
km_time <- mean(km_time)

#random
km_matrix_time <- numeric(50)
for(i in 1:50){
km_matrix_time[i] = system.time(mbkmeans::mini_batch(data_matrix,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "random"))[3]
}
km_matrix_time <- mean(km_matrix_time)



km_hdf5_time <- numeric(50)
for(i in 1:50){
km_hdf5_time[i] = system.time(mbkmeans::mini_batch(data_hdf5,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "random"))[3]
}
km_hdf5_time <- mean(km_hdf5_time)


#kmeans++
kmplus_matrix_time <- numeric(50)
for(i in 1:50){
kmplus_matrix_time[i] = system.time(mbkmeans::mini_batch(data_matrix,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "kmeans++"))[3]
}
kmplus_matrix_time <- mean(kmplus_matrix_time)



kmplus_hdf5_time <- numeric(50)
for(i in 1:50){
kmplus_hdf5_time[i] = system.time(mbkmeans::mini_batch(data_hdf5,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "kmeans++"))[3]
}
kmplus_hdf5_time <- mean(kmplus_hdf5_time)

rbind(km_time,km_matrix_time,km_hdf5_time,kmplus_matrix_time,kmplus_hdf5_time)

```

```{r accuracy,warning=FALSE}
#accuracy
#km

km_ari<-numeric(50)
for(i in 1:50){
    
km_cluster<-kmeans(data_matrix,centers = 3,iter.max = 10,nstart=1)

km_ari[i] = adjustedRandIndex(km_cluster$cluster,sim_data$true_cluster_id)
}
km_ari<-mean(km_ari)

#random

km_matrix_ari<-numeric(50)
for(i in 1:50){
    
km_matrix_cluster<-mbkmeans::mini_batch(data_matrix,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "random")

km_matrix_ari[i] = adjustedRandIndex(km_matrix_cluster$Clusters,sim_data$true_cluster_id)
}
km_matrix_ari<-mean(km_matrix_ari)


km_hdf5_ari <-numeric(50)
for(i in 1:50){
    
km_hdf5_cluster<-mbkmeans::mini_batch(data_hdf5,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "random")

km_hdf5_ari[i] = adjustedRandIndex(km_hdf5_cluster$Clusters,sim_data$true_cluster_id)
}
km_hdf5_ari<-mean(km_hdf5_ari)


#kmeans++
kmplus_matrix_ari <-numeric(50)
for(i in 1:50){
    
kmplus_matrix_cluster<-mbkmeans::mini_batch(data_matrix,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "kmeans++")

kmplus_matrix_ari[i] = adjustedRandIndex(kmplus_matrix_cluster$Clusters,sim_data$true_cluster_id)
}
kmplus_matrix_ari<-mean(kmplus_matrix_ari)


kmplus_hdf5_ari <-numeric(50)
for(i in 1:50){

kmplus_hdf5_cluster<-mbkmeans::mini_batch(data_hdf5,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "kmeans++")

kmplus_hdf5_ari[i] = adjustedRandIndex(kmplus_hdf5_cluster$Clusters,sim_data$true_cluster_id)
}
kmplus_hdf5_ari<-mean(kmplus_hdf5_ari)

rbind(km_ari,km_matrix_ari,km_hdf5_ari,kmplus_matrix_ari,kmplus_hdf5_ari)
```


```{r memory,warning=FALSE}
#memory
memory_compare<-profvis({
        
   km1<-kmeans(data_matrix,centers = 3,iter.max = 10,nstart=1)
    
   km_matrix<-mbkmeans::mini_batch(data_matrix,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "random")
   
   km_hdf5<-mbkmeans::mini_batch(data_hdf5,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "random")

#kmeans++
   kmplus_matrix<-mbkmeans::mini_batch(data_matrix,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "kmeans++")
   
   kmplus_hdf5<-mbkmeans::mini_batch(data_hdf5,clusters = 3,batch_size = 250,max_iters=10, num_init = 1,init_fraction = 0.25,initializer = "kmeans++")
    
})

htmlwidgets::saveWidget(memory_compare, "memory_compare.html")
browseURL("memory_compare.html")
```

