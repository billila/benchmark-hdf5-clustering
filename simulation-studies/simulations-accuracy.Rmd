---
title: "Simulation study: Assessing accuracy"
author: "Stephanie Hicks"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
   html_document:
        toc: true
        toc_float: true
        highlight: tango
        number_sections: true
---

# Summary

In this set of simulations, we simulate a mixture of gaussian 
distributions for cells from three clusters. We are assessing
the accuracy of _k_-means and `mbkmeans()`. 

# Workspace Setup

```{r, wkspace-setup, results='hide', message=FALSE, warning=FALSE}
library(mbkmeans)

# for data viz 
library(dplyr)
library(cowplot)

# parallization
library(parallel)
# can see how many cores are available
detectCores() 

# number of cores for parallelization
cores <- 1
B <- 50

## load helper functions
for (f in list.files("R", "\\.(r|R)$")) {
    source(f)
}
```

Here we simulate a mixture of gaussian data 
for cells from three celltypes / clusters. 
Cells are distributed according to a bivariate
normal in a 2-D biological subspace. Each cell
type has a different x/y center and a different SD.

For example, here we simulate bivariate data and plot
the true cluster locations to show what the true
data structure looks likes. 

```{r}
nC <- 1000  # number of cells
nG <- 5000 # number of genes

sim_data <- simulate_gauss_mix(n_cells=nC, n_genes=nG)

# check dimension of observed data
dim(sim_data$obs_data)

# Plot the true cluster locations
ref.cols <- c("blue", "brown1", "gold2")
clust1 <- ref.cols[sim_data$true_cluster_id]
plot(sim_data$true_data, pch=16, cex=1.5, col=clust1, 
     main=paste0("True clusters"))
```

# Benchmark clustering methods 

Here we set up the `bench_accuracy` function to simulate
data using the `simulate_gauss_mix()` function and then
apply _k_-means using the `stats::kmeans()` function and 
mini-batch _k_-means using the `mbkmeans::mini_batch()` 
function. 

```{r}
bench_accuracy <- function(i, n_cells, n_genes, k_centers, 
                           batch_size=batch_size, 
                           num_init = num_init, 
                           max_iters = max_iters, 
                           init_fraction = init_fraction, 
                           initializer = initializer) {
    # simulate data 
    sim_data <- simulate_gauss_mix(n_cells=n_cells, 
                                   n_genes=n_genes)
    
    # apply clustering methods 
    kmeans_output <- stats::kmeans(sim_data$obs_data, 
                                   centers=k_centers)
    mbkmeans_output <- mbkmeans::mini_batch(sim_data$obs_data, 
                clusters = k_centers, batch_size = batch_size, 
                num_init = num_init, max_iters = max_iters, 
                init_fraction = init_fraction,
                initializer = initializer)

    # return true, kmeans, and mbkmeans cluster ids
    list(true_cluster_id = sim_data$true_cluster_id, 
         kmeans_cluster_id=as.numeric(kmeans_output$cluster), 
         mbkmeans_cluster_id = mbkmeans_output$Clusters)
}
```

## Simulation looking at differences in batch sizes

Here we simulate data with different `batch_size`s 
in the `mbkmeans::mini_batch()` function. We simulate 
batch sizes of 1, 5, 25 and 100 percent of the data and
compare the accuracy to _k_-means. 

First, let's set up some parameters for all simulation 
studies in this section: 

```{r}
nC <- 1000
nG <- 500
```


### `batch_size = 1` (or .1 percent of data)

```{r}
# simulate data
save_bs_0001 <- mclapply(seq_len(B), n_cells=nC, n_genes =nG, 
                  bench_accuracy, k_centers = 3,
                  batch_size = nC*.001, num_init = 10, max_iters = 100, 
                  init_fraction = .1, initializer = "random", 
                  mc.cores=cores)

# calculate adjusted Rand Index 
ari_output_bs_0001 <- plyr::ldply(save_bs_0001, function(xx){
    ari_kmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$kmeans_cluster_id)
    ari_mbkmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$mbkmeans_cluster_id)
  c(ari_kmeans=ari_kmeans, ari_mbkmeans=ari_mbkmeans)  
})

# boxplot
p_bs_0001 <- tidyr::gather(ari_output_bs_0001) %>% 
    ggplot(aes(x=key, y = value)) + 
    geom_boxplot() + geom_jitter() + 
    xlab("clustering method") + 
    ylab("adjusted rand index") + 
    ggtitle("batch_size = 1 (0.1% of data)")
p_bs_0001
```

### `batch_size = 5` (or .5 percent of data)

```{r}
# simulate data
save_bs_0005 <- mclapply(seq_len(B), n_cells=nC, n_genes =nG, 
                  bench_accuracy, k_centers = 3,
                  batch_size = nC*.005, num_init = 10, max_iters = 100, 
                  init_fraction = .1, initializer = "random", 
                  mc.cores=cores)

# calculate adjusted Rand Index 
ari_output_bs_0005 <- plyr::ldply(save_bs_0005, function(xx){
    ari_kmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$kmeans_cluster_id)
    ari_mbkmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$mbkmeans_cluster_id)
  c(ari_kmeans=ari_kmeans, ari_mbkmeans=ari_mbkmeans)  
})

# boxplot
p_bs_0005 <- tidyr::gather(ari_output_bs_0005) %>% 
    ggplot(aes(x=key, y = value)) + 
    geom_boxplot() + geom_jitter() + 
    xlab("clustering method") + 
    ylab("adjusted rand index") + 
    ggtitle("batch_size = 5 (0.5% of data)")
p_bs_0005
```

### `batch_size = 10` (or 1 percent of data)

```{r}
# simulate data
save_bs_001 <- mclapply(seq_len(B), n_cells=nC, n_genes =nG, 
                  bench_accuracy, k_centers = 3,
                  batch_size = nC*.01, num_init = 10, max_iters = 100, 
                  init_fraction = .1, initializer = "random", 
                  mc.cores=cores)

# calculate adjusted Rand Index 
ari_output_bs_001 <- plyr::ldply(save_bs_001, function(xx){
    ari_kmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$kmeans_cluster_id)
    ari_mbkmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$mbkmeans_cluster_id)
  c(ari_kmeans=ari_kmeans, ari_mbkmeans=ari_mbkmeans)  
})

# boxplot
p_bs_001 <- tidyr::gather(ari_output_bs_001) %>% 
    ggplot(aes(x=key, y = value)) + 
    geom_boxplot() + geom_jitter() + 
    xlab("clustering method") + 
    ylab("adjusted rand index") + 
    ggtitle("batch_size = 10 (1% of data)")
p_bs_001

```


### `batch_size = 50` (or 5 percent of data)
```{r}
# simulate data
save_bs_005 <- mclapply(seq_len(B), n_cells=nC, n_genes =nG, 
                  bench_accuracy, k_centers = 3,
                  batch_size = nC*.05, num_init = 10, max_iters = 100, 
                  init_fraction = .1, initializer = "random", 
                  mc.cores=cores)

# calculate adjusted Rand Index 
ari_output_bs_005 <- plyr::ldply(save_bs_005, function(xx){
    ari_kmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$kmeans_cluster_id)
    ari_mbkmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$mbkmeans_cluster_id)
  c(ari_kmeans=ari_kmeans, ari_mbkmeans=ari_mbkmeans)  
})

# boxplot
p_bs_005 <- tidyr::gather(ari_output_bs_005) %>% 
    ggplot(aes(x=key, y = value)) + 
    geom_boxplot() + geom_jitter() + 
    xlab("clustering method") + 
    ylab("adjusted rand index") + 
    ggtitle("batch_size = 50 (5% of data)")
p_bs_005

```

### `batch_size = 250` (or 25 percent of data)
```{r}
# simulate data
save_bs_025 <- mclapply(seq_len(B), n_cells=nC, n_genes =nG, 
                  bench_accuracy, k_centers = 3,
                  batch_size = nC*.25, num_init = 10, max_iters = 100, 
                  init_fraction = .1, initializer = "random", 
                  mc.cores=cores)

# calculate adjusted Rand Index 
ari_output_bs_025 <- plyr::ldply(save_bs_025, function(xx){
    ari_kmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$kmeans_cluster_id)
    ari_mbkmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$mbkmeans_cluster_id)
  c(ari_kmeans=ari_kmeans, ari_mbkmeans=ari_mbkmeans)  
})

# boxplot
p_bs_025 <- tidyr::gather(ari_output_bs_025) %>% 
    ggplot(aes(x=key, y = value)) + 
    geom_boxplot() + geom_jitter() + 
    xlab("clustering method") + 
    ylab("adjusted rand index") + 
    ggtitle("batch_size = 250 (25% of data)")
p_bs_025

```

### `batch_size = 500` (or 50 percent of data)
```{r}
# simulate data
save_bs_050 <- mclapply(seq_len(B), n_cells=nC, n_genes =nG, 
                  bench_accuracy, k_centers = 3,
                  batch_size = nC*.50, num_init = 10, max_iters = 100, 
                  init_fraction = .1, initializer = "random", 
                  mc.cores=cores)

# calculate adjusted Rand Index 
ari_output_bs_050 <- plyr::ldply(save_bs_050, function(xx){
    ari_kmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$kmeans_cluster_id)
    ari_mbkmeans <- mclust::adjustedRandIndex(
            xx$true_cluster_id,xx$mbkmeans_cluster_id)
  c(ari_kmeans=ari_kmeans, ari_mbkmeans=ari_mbkmeans)  
})

# boxplot
p_bs_050 <- tidyr::gather(ari_output_bs_050) %>% 
    ggplot(aes(x=key, y = value)) + 
    geom_boxplot() + geom_jitter() + 
    xlab("clustering method") + 
    ylab("adjusted rand index") + 
    ggtitle("batch_size = 500 (50% of data)")
p_bs_050
```

### Summary

```{r}
p_out <- plot_grid(p_bs_0001, p_bs_0005, p_bs_001, 
                   p_bs_005, p_bs_025, p_bs_050,  
                   ncol = 3, 
                   labels = LETTERS[1:6], label_size = 30)
pdf("simulation-studies/figs/accuracy_batch_size.pdf", width=15, height=10)
print(p_out)
dev.off()
```


