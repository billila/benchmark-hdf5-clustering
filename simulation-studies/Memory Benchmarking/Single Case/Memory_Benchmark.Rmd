---
title: "Memory_Benchmark"
author: "Ruoxi Liu"
date: "5/17/2019"
output: html_document
---
```{r setup, include=FALSE, warning=FALSE}
library(mbkmeans)
library(rhdf5)
library(HDF5Array)
library(profvis)
```

Simulate random data from `rnorm()` and save 
data as a `HDF5Matrix` object. 

```{r}
n_cells <- 1000
n_genes <- 500

obs_data <- matrix(rnorm(n_cells*n_genes ), 
                   nrow = n_genes, ncol = n_cells)
sim_data_hdf5 <- as(obs_data,"HDF5Matrix")
```

## Memory profiling using `profvis()`

Apply memory profiling to `stats::kmeans` with data in memory

```{r}
memory_compare1 <- profvis({
  km_test <- stats::kmeans(obs_data, centers=3, 
                           iter.max = 100, nstart = 10)
})

htmlwidgets::saveWidget(memory_compare1, "profvis_kmeans.html")
```

Apply memory profiling to `mbkmeans::mini_batch()` with data in memory

```{r}
memory_compare2 <- profvis({
  mbkmeans_test <- mbkmeans::mini_batch(
            obs_data, clusters = 3, 
            batch_size = 250, num_init = 10, 
            max_iters = 100, init_fraction = 0.1,
            initializer = "random")
})

htmlwidgets::saveWidget(memory_compare2, "profvis_mbkmeans.html")
```

Apply memory profiling to `mbkmeans::mini_batch()` with HDF5 file

```{r}
memory_compare3 <- profvis({
hdf5_test <- mbkmeans::mini_batch(
            sim_data_hdf5, clusters = 3, 
            batch_size = 250, num_init = 10, 
            max_iters = 100, init_fraction = 0.1,
            initializer = "random")
})

htmlwidgets::saveWidget(memory_compare3, "profvis_hdf5.html")
```

## Memory profiling using `Rprof()`

Apply memory profiling to `stats::kmeans` with data in memory

```{r}
Rprof("Rprof_kmeans.out", append = TRUE, memory.profiling = TRUE)
km_test <- stats::kmeans(obs_data, centers=3, iter.max = 100, nstart = 10)
Rprof(NULL)
```

Apply memory profiling to `mbkmeans::mini_batch()` with data in memory

```{r}
Rprof("Rprof_mbkmeans.out", append = TRUE, memory.profiling = TRUE)
mbkmeans_test <- mbkmeans::mini_batch(
            obs_data, clusters = 3, 
            batch_size = 250, num_init = 10, 
            max_iters = 100, init_fraction = 0.1,
            initializer = "random")
Rprof(NULL)
```

Apply memory profiling to `mbkmeans::mini_batch()` with HDF5 file

```{r}
Rprof("Rprof_hdf5.out", append = TRUE, memory.profiling = TRUE)
hdf5_test <- mbkmeans::mini_batch(
            sim_data_hdf5, clusters = 3, 
            batch_size = 250, num_init = 10, 
            max_iters = 100, init_fraction = 0.1,
            initializer = "random")
Rprof(NULL)
```
 
